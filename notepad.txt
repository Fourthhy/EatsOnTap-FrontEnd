import React from 'react';
import {
  ComposedChart,
  Line,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer, // <-- 1. Import ResponsiveContainer
  DefaultLegendContent,
  DefaultTooltipContent,
} from 'recharts';

// #region Sample data for KPI-003 (TADMC)
const tadmcData = [
  { Day: 'Mon 1', AcceptableRange: [58, 62], TADMC: 60.50 },
  { Day: 'Tue 2', AcceptableRange: [58, 62], TADMC: 61.25 },
  { Day: 'Wed 3', AcceptableRange: [58, 62], TADMC: 59.80 },
  { Day: 'Thu 4', AcceptableRange: [58, 62], TADMC: 57.90 },
  { Day: 'Fri 5', AcceptableRange: [58, 62], TADMC: 63.50 },
  { Day: 'Mon 6', AcceptableRange: [58, 62], TADMC: 61.90 },
];
// #endregion

// Utility to hide the band data key ('AcceptableRange') from the tooltip
const renderTooltipWithoutRange = ({ payload, content, ...rest }) => {
  if (!payload) return <DefaultTooltipContent {...rest} />;
  
  const newPayload = payload.filter(x => x.dataKey !== 'AcceptableRange');
  return <DefaultTooltipContent payload={newPayload} {...rest} />;
};

// Utility to hide the band data key ('AcceptableRange') from the legend
const renderLegendWithoutRange = ({ payload, content, ref, ...rest }) => {
  if (!payload) return <DefaultLegendContent {...rest} />;

  const newPayload = payload
    .filter(x => x.dataKey !== 'AcceptableRange')
    .map(item => ({
      ...item,
      value: item.dataKey === 'TADMC' ? 'Actual Daily Cost' : item.value 
    }));
    
  if (payload.some(x => x.dataKey === 'AcceptableRange')) {
    newPayload.unshift({
      dataKey: 'AcceptableRange',
      color: '#cccccc',
      type: 'square',
      value: 'Target Range (₱58-₱62)'
    });
  }
  return <DefaultLegendContent payload={newPayload} {...rest} />;
};

export function BandedChartBox() {
  const totalTADMC = tadmcData.reduce((sum, item) => sum + item.TADMC, 0);
  const averageTADMC = (totalTADMC / tadmcData.length).toFixed(2);
  
  return (
    // Set a controlled size for the container of the chart (e.g., max-width 500px, height 300px)
    // The chart will now fill 100% of this parent div's dimensions.
    <div className="border-black border-[1px]" style={{ padding: '20px', width: '100%', maxWidth: '700px', height: '300px', display: "flex", justifyContent: "start", alignItems: "end" }}>

      {/* 2. Wrap the chart in ResponsiveContainer */}
      <ResponsiveContainer width="100%" height="100%">
        <ComposedChart
          // Removed fixed size styles here (width, maxWidth, maxHeight)
          // The ComposedChart will now take 100% of the ResponsiveContainer's size.
          data={tadmcData}
          margin={{ top: 0, right: 30, left: -20, bottom: 5 }}
        >
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="Day" />
          <YAxis 
              label={{ value: 'Cost (in ₱)', angle: -90, position: 'insideLeft' }} 
              domain={[55, 65]}
          />
          <Tooltip content={renderTooltipWithoutRange} />
          
          <Area 
              type="monotone" 
              dataKey="AcceptableRange" 
              stroke="none" 
              fill="#cccccc"
              connectNulls 
              dot={false} 
              activeDot={false} 
          />
          
          <Line 
              type="monotone" 
              dataKey="TADMC" 
              name="Actual Daily Cost" 
              stroke="#1919b5ff"
              strokeWidth={2} 
              connectNulls 
          />
          
          <Legend content={renderLegendWithoutRange} />
        </ComposedChart>
      </ResponsiveContainer>
    
    </div>
  );
}